# -*- coding: utf-8 -*-
"""Official_How Smoking affects Diabetes using the NHANES Dataset_Code

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YIaQK547gt-_S6Ay8T2JrmWhpFo85QYD
"""

import numpy as np
import pandas as pd
import statsmodels.api as sm
import scipy.stats as stats
import matplotlib.pyplot as plt
import statsmodels.formula.api as smf #We will use this library, but others such as sci-kit learn is also available
from scipy.stats import mannwhitneyu, wilcoxon, f_oneway, kruskal, chi2_contingency, fisher_exact
from sklearn.metrics import roc_curve, roc_auc_score

from google.colab import files
uploaded = files.upload()

NHANES = pd.read_csv('NHANES.csv', index_col=0)

print(NHANES.shape)

NHANES_2 = NHANES[(NHANES['age'] >= 18) &
                  (NHANES['smoke_amount'].notna()) &
                  (NHANES['bmi'].notna()) &
                  (NHANES['alcohol_amount'].notna()) &
                  (NHANES['diabetes'].notna())].copy()

print(NHANES['age'].min(), NHANES['age'].max())
print(NHANES_2['age'].min(), NHANES_2['age'].max())

print(NHANES['smoke_amount'].isna().sum())
print(NHANES_2['smoke_amount'].isna().sum())

print(NHANES['diabetes'].isna().sum())
print(NHANES_2['diabetes'].isna().sum())

print(NHANES['bmi'].isna().sum())
print(NHANES_2['bmi'].isna().sum())

print(NHANES['alcohol_amount'].isna().sum())
print(NHANES_2['alcohol_amount'].isna().sum())

print(NHANES['race_ethnicity'].isna().sum())
print(NHANES_2['race_ethnicity'].isna().sum())

print(NHANES['race_ethnicity'].value_counts(dropna=False))

print(NHANES_2['race_ethnicity'].value_counts(dropna=False))

print(NHANES_2['sex'].value_counts(dropna=False))

print(NHANES_2.shape)

"""categorizing disbetes"""

NHANES_2['outcome'] = pd.NA  # default value as NA
NHANES_2.loc[NHANES_2['diabetes'].isin(['No']), 'outcome'] = 0
NHANES_2.loc[NHANES_2['diabetes'].isin(['Yes', 'Borderline']), 'outcome'] = 1
NHANES_2['outcome'] = NHANES_2['outcome'].astype('int64')

print(NHANES_2['outcome'].value_counts(dropna=False))

print(NHANES_2['diabetes'].value_counts(dropna=False))

"""Smoking"""

NHANES_2['smoking_cat'] = pd.NA  # default value as NA
NHANES_2.loc[NHANES_2['smoke_amount'] < 10, 'smoking_cat'] = 'light'
NHANES_2.loc[(NHANES_2['smoke_amount'] >= 10) & (NHANES_2['smoke_amount'] < 20), 'smoking_cat'] = 'normal'
NHANES_2.loc[NHANES_2['smoke_amount'] >= 20, 'smoking_cat'] = 'heavy'

light = NHANES_2[NHANES_2['smoking_cat'] == 'light']['smoking_cat'].to_numpy()
normal = NHANES_2[NHANES_2['smoking_cat'] == 'normal']['smoking_cat'].to_numpy()
heavy = NHANES_2[NHANES_2['smoking_cat'] == 'heavy']['smoking_cat'].to_numpy()

print(NHANES_2['smoking_cat'].value_counts(dropna=False))

table_1 = pd.crosstab(NHANES_2['smoking_cat'], NHANES_2['outcome'], dropna=False)
print(table_1)

stat, p_val, dof, expected = chi2_contingency(table_1, correction=False)
print("Chisq-statistics", stat)
print("p-value:", p_val)
print("df:", dof)
print("expected counts:", expected)

"""Confounder 1"""

NHANES_2['bmi_cats'] = pd.NA  # default value as NA
NHANES_2.loc[NHANES_2['bmi'] < 18.5, 'bmi_cats'] = 'underweight'
NHANES_2.loc[(NHANES_2['bmi'] >= 18.5) & (NHANES_2['bmi'] < 25), 'bmi_cats'] = 'healthy'
NHANES_2.loc[(NHANES_2['bmi'] >= 25) & (NHANES_2['bmi'] < 30), 'bmi_cats'] = 'overweight'
NHANES_2.loc[NHANES_2['bmi'] >= 30, 'bmi_cats'] = 'obese'

print(NHANES_2['bmi_cats'].value_counts(dropna=False))

table_2 = pd.crosstab(NHANES_2['bmi_cats'], NHANES_2['outcome'], dropna=False)
print(table_2)

stat, p_val, dof, expected = chi2_contingency(table_2, correction=False)
print("Chisq-statistics", stat)
print("p-value:", p_val)
print("df:", dof)
print("expected counts:", expected)

"""Confounder 2"""

NHANES_2['alc_cats'] = pd.NA  # default value as NA
NHANES_2.loc[NHANES_2['alcohol_amount'] < 5, 'alc_cats'] = 'casual'
NHANES_2.loc[(NHANES_2['alcohol_amount'] >= 5) & (NHANES_2['alcohol_amount'] < 10), 'alc_cats'] = 'excessive'
NHANES_2.loc[NHANES_2['alcohol_amount'] >= 10, 'alc_cats'] = 'addict'

print(NHANES_2['alc_cats'].value_counts(dropna=False))

table_3 = pd.crosstab(NHANES_2['alc_cats'], NHANES_2['outcome'], dropna=False)
print(table_2)

stat, p_val, dof, expected = chi2_contingency(table_3, correction=True)
print("Chisq-statistics", stat)
print("p-value:", p_val)
print("df:", dof)
print("expected counts:", expected)

"""logistic regression"""

uni_model = smf.logit(
                        'outcome ~ C(smoking_cat, Treatment(reference="normal"))',  #'outcome ~ age' example for continuous variable
                        data = NHANES_2).fit()
print(uni_model.summary())

print(np.exp(uni_model.params))

print(np.exp(uni_model.conf_int()))

"""multivariable model???"""

multi_model = smf.logit(
                          'outcome ~ C(smoking_cat, Treatment(reference="normal")) + C(bmi_cats, Treatment(reference="healthy")) + C(alc_cats, Treatment(reference="casual"))',
                          data=NHANES_2).fit()
print(multi_model.summary())

print(np.exp(multi_model.params))

print(np.exp(multi_model.conf_int()))

"""Results/ROC"""

NHANES_2['y_prediction'] = multi_model.predict(NHANES_2)

fpr, tpr, thresholds = roc_curve(NHANES_2['outcome'], NHANES_2['y_prediction'])
auc = roc_auc_score(NHANES_2['outcome'], NHANES_2['y_prediction'])

# Plot ROC
plt.figure(figsize=(5,5))
plt.plot(fpr, tpr, label=f'AUROC = {auc:.3f}')
plt.plot([0,1], [0,1], 'k--')
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.legend(loc='lower right')
plt.show()

NHANES_2[['smoking_cat', 'bmi_cats', 'alc_cats', 'outcome', 'y_prediction']].head(2)